{% extends 'base.html' %}

{% block title %}Projects{% endblock %}

{% block content %}

{% set status_colors = {
  'Not Started': 'secondary',
  'In Progress': 'primary',
  'On Hold': 'warning',
  'Needs Review': 'info',
  'Completed': 'success',
  'Cancelled': 'danger',
  'Delayed': 'danger'
} %}

{# separăm proiectele în două liste #}
{% set active_statuses = ['Not Started', 'In Progress', 'On Hold', 'Needs Review', 'Delayed'] %}
{% set done_statuses = ['Completed', 'Cancelled'] %}

{% set active_projects = projects | selectattr('status', 'in', active_statuses) | list %}
{% set finished_projects = projects | selectattr('status', 'in', done_statuses) | list %}

<!-- Active Projects -->
<section class="section-title bg-light py-4 position-relative">
  <div class="section-header position-absolute top-0 start-50 translate-middle bg-light px-3">
    <h2 class="mb-0 text-primary">Active Projects ({{ active_projects|length }})</h2>
  </div>
    <div class="container-fluid">
        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-primary" onclick="createProject()">Add a new project</button>
        </div>
    </div>

  <div class="container-fluid">
    <div class="row flex-row flex-nowrap overflow-auto">
      {% if active_projects %}
        {% for project in active_projects %}
        <div class="col-lg-3 col-md-4 col-sm-6 col-10 mb-3">
          <div class="card h-100">
            <div class="overflow-hidden" style="max-height: 200px;">
              <img src="{{ url_for('static', filename=project.background_picture) }}"
                   class="img-fluid w-100" alt="Project Image" style="object-fit: cover;">
            </div>
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ project.name }}</h5>
              <p class="card-text">{{ project.description }}</p>

              <div class="progress mb-2">
                <div class="progress-bar bg-{{ status_colors.get(project.status, 'dark') }}"
                     role="progressbar"
                     style="width: {{ project.progress }}%"
                     aria-valuenow="{{ project.progress }}" aria-valuemin="0" aria-valuemax="100">
                  {{ project.progress }}%
                </div>
              </div>
              <span class="badge bg-{{ status_colors.get(project.status, 'dark') }}">
                {{ project.status }}
              </span>

              <p class="card-text mt-2">
                <small class="text-muted">Last updated {{ project.updated_at }}</small>
              </p>

              <div class="mt-auto">
                <a href="{{ url_for('projects.project_detail', project_id=project.id) }}"
                   class="btn btn-primary w-100">Go to Project</a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="col-12 text-center">
          <h5 class="text-muted">No active projects.</h5>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<!-- Completed / Cancelled Projects -->
<section class="section-title bg-light py-4 position-relative">
  <div class="section-header position-absolute top-0 start-50 translate-middle bg-light px-3">
    <h2 class="mb-0 text-primary">Completed / Cancelled ({{ finished_projects|length }})</h2>
  </div>

  <div class="container-fluid">
    <div class="row flex-row flex-nowrap overflow-auto">
      {% if finished_projects %}
        {% for project in finished_projects %}
        <div class="col-lg-3 col-md-4 col-sm-6 col-10 mb-3">
          <div class="card h-100 border-success-subtle">
            <div class="overflow-hidden" style="max-height: 200px;">
              <img src="{{ url_for('static', filename=project.background_picture) }}"
                   class="img-fluid w-100" alt="Project Image" style="object-fit: cover; filter: grayscale(0.2);">
            </div>
            <div class="card-body d-flex flex-column">
              <h5 class="card-title">{{ project.name }}</h5>
              <p class="card-text">{{ project.description }}</p>

              <div class="progress mb-2">
                <div class="progress-bar bg-{{ status_colors.get(project.status, 'dark') }}"
                     role="progressbar"
                     style="width: {{ project.progress }}%"
                     aria-valuenow="{{ project.progress }}" aria-valuemin="0" aria-valuemax="100">
                  {{ project.progress }}%
                </div>
              </div>
              <span class="badge bg-{{ status_colors.get(project.status, 'dark') }}">
                {{ project.status }}
              </span>

              <p class="card-text mt-2">
                <small class="text-muted">Last updated {{ project.updated_at }}</small>
              </p>

              <div class="mt-auto">
                <a href="{{ url_for('projects.project_detail', project_id=project.id) }}"
                   class="btn btn-outline-secondary w-100">View Project</a>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="col-12 text-center">
          <h5 class="text-muted">No completed or cancelled projects.</h5>
        </div>
      {% endif %}
    </div>
  </div>
</section>

<!-- same SweetAlert createProject() as in dashboard -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  function createProject() {
    Swal.fire({
      title: 'Create a New Project',
      html: `
        <form id="project-form" enctype="multipart/form-data">
          <input type="text" id="project-name" class="swal2-input" placeholder="Project Name" required>
          <textarea id="project-description" class="swal2-textarea" placeholder="Project Description" required></textarea>
          <input type="file" id="background-picture" class="swal2-file" accept="image/*">
          <div style="margin-top: 15px;">
            <label class="switch">
              <input type="checkbox" id="project-public" checked>
              <span class="slider"></span>
            </label>
            <span class="toggle-label">Public</span>
          </div>
        </form>
      `,
      focusConfirm: false,
      preConfirm: () => {
        const name = document.getElementById('project-name').value;
        const description = document.getElementById('project-description').value;
        const file = document.getElementById('background-picture').files[0];
        const isPublic = document.getElementById('project-public').checked;

        if (!name || !description) {
          Swal.showValidationMessage('Please fill out the name and description.');
          return false;
        }

        const formData = new FormData();
        formData.append('name', name);
        formData.append('description', description);
        formData.append('is_public', isPublic ? 'true' : 'false');
        if (file) formData.append('background_picture', file);
        return formData;
      },
      confirmButtonText: 'Create',
      showCancelButton: true,
    }).then((result) => {
      if (result.isConfirmed) {
        fetch('/create-project', {
          method: 'POST',
          headers: {
            'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
          },
          body: result.value
        })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Success', 'Project created successfully!', 'success')
              .then(() => location.reload());
          } else {
            Swal.fire('Error', data.message || 'Failed to create project.', 'error');
          }
        })
        .catch(() => Swal.fire('Error', 'An unexpected error occurred.', 'error'));
      }
    });
  }
</script>

<style>
  .section-title { border-top: 2px solid #007bff; }
  .section-header { top: -15px; transform: translateX(-50%); z-index: 10; }
  .section-header h2 { font-size: 1.5rem; font-weight: bold; color: #007bff; }
</style>

{% endblock %}
