{% extends 'base.html' %} {% block title %}Project: {{ project.name }}{%
endblock %} {% block head_extra %} {% block head %}
<link
  rel="stylesheet"
  href="{{ url_for('static', filename='css/project.css') }}"
/>
{% endblock %} {% endblock %} {% block content %}
<div
  class="container-fluid d-flex flex-row"
  style="height: 100vh; overflow: hidden"
>
  <!-- Sidebar (project info) -->
  <div class="col-md-3 border-end p-3 bg-light">
    <div class="position-relative overflow-hidden" style="max-height: 200px">
      <img
        src="{{ url_for('static', filename=project.background_picture) }}"
        class="img-fluid w-100"
        alt="Project Image"
        style="object-fit: cover"
      />
      <div
        class="position-absolute bottom-0 start-0 w-100 bg-dark bg-opacity-50 text-white p-2"
      >
        <p class="fw-bold m-0">{{ project.name }}</p>
      </div>
    </div>

    <div class="d-flex align-items-center mt-3">
      <img
        src="{{ url_for('static', filename=project.creator.profile_picture) }}"
        alt="Creator Image"
        class="rounded-circle"
        style="width: 40px; height: 40px; object-fit: cover"
      />
      <p class="fw-bold ms-2 mb-0">
        Created by: {{ project.creator.fullname }}
      </p>
    </div>

    <div class="mt-4">
      <p class="fw-bold">Description</p>
      <p>{{ project.description }}</p>
    </div>

    <div class="mt-4">
      <p class="fw-bold mb-1">Visibility</p>
      {% if project.is_public %}
      <span class="badge bg-success"><i class="bi bi-unlock"></i> Public</span>
      {% else %}
      <span class="badge bg-secondary"><i class="bi bi-lock"></i> Private</span>
      {% endif %}
    </div>

    <div class="mt-4">
      <p class="fw-bold">Status</p>
      {% set status_colors = { 'Not Started': 'secondary', 'In Progress':
      'primary', 'On Hold': 'warning', 'Needs Review': 'info', 'Completed':
      'success', 'Cancelled': 'danger', 'Delayed': 'danger' } %}
      <span class="badge bg-{{ status_colors.get(project.status, 'dark') }}"
        >{{ project.status }}</span
      >
      {% if current_user.id == project.created_by %}
      <button
        class="btn btn-sm btn-outline-primary mt-2 d-flex align-items-center gap-1"
        onclick="changeProjectStatus()"
      >
        <i class="bi bi-arrow-repeat"></i> Change Status
      </button>

      <button
        class="btn btn-sm btn-outline-danger mt-2 d-flex align-items-center gap-1"
        onclick="deleteProject()"
      >
        <i class="bi bi-trash"></i> Delete Project
      </button>
      {% endif %}
    </div>

    <div class="mt-4">
      <div class="d-flex justify-content-between">
        <div>
          <p class="fw-bold mb-1">Created at</p>
          <p class="text-muted">
            {{ project.created_at.strftime('%Y-%m-%d %H:%M') }}
          </p>
        </div>
        <div>
          <p class="fw-bold mb-1">Last update</p>
          <p class="text-muted">
            {{ project.updated_at.strftime('%Y-%m-%d %H:%M') }}
          </p>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <p class="fw-bold mb-0">Contributors</p>
        {% if current_user.id == project.created_by %}
        <button
          class="btn btn-sm btn-outline-primary"
          onclick="addContributor()"
        >
          Add
        </button>
        {% endif %}
      </div>

      <div
        class="border rounded w-100 p-2 bg-white"
        style="max-height: 150px; overflow-y: auto"
      >
        {% if project.contributors %} {% for user in project.contributors %}
        <a
          href="{{ url_for('profile.profile', user_id=user.id) }}"
          class="d-flex align-items-center mt-2 text-decoration-none text-dark"
        >
          <img
            src="{{ url_for('static', filename=user.profile_picture) }}"
            alt="Profile"
            class="rounded-circle me-2"
            style="width: 30px; height: 30px; object-fit: cover"
          />
          <p class="ms-2 mb-0">{{ user.fullname }} ({{ user.username }})</p>
        </a>
        {% endfor %} {% else %}
        <p class="text-muted">No contributors yet.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Main Content: Tasks -->
  <div class="col-md-9 p-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h5 class="mb-0">Tasks</h5>
      <button class="btn btn-sm btn-success" onclick="addTask()">
        Add Task
      </button>
    </div>

    {% if project.tasks %}
    <div class="tasks-wrapper d-flex gap-3 w-100">
      <!-- TO DO Column -->
      <div
        class="task-column flex-fill"
        ondrop="drop(event, 'To Do')"
        ondragover="allowDrop(event)"
      >
        <h6 class="text-center fw-bold">TO DO</h6>
        {% for task in project.tasks if task.status == 'To Do' %}
        <div
          class="card mb-3 position-relative"
          draggable="true"
          ondragstart="drag(event)"
          id="task-{{ task.id }}"
        >
          {% if current_user.id == project.created_by or current_user in
          project.contributors %}
          <button
            class="btn p-0 border rounded-circle d-inline-flex justify-content-center align-items-center"
            style="
              width: 28px;
              height: 28px;
              position: absolute;
              top: 6px;
              right: 6px;
              z-index: 10;
            "
            title="Delete task"
            onclick="deleteTask({{ task.id }})"
          >
            <img
              src="{{ url_for('static', filename='images/delete-icon.png') }}"
              alt="Delete task"
              style="
                width: 14px;
                height: 14px;
                object-fit: contain;
                display: block;
              "
            />
          </button>
          {% endif %}
          <div class="card-body">
            <h6 class="card-title">{{ task.name }}</h6>
            <p class="card-text">{{ task.description }}</p>
            <span
              class="badge bg-{{ 'danger' if task.priority == 3 else 'warning' if task.priority == 2 else 'success' }}"
            >
              Priority {{ task.priority }}
            </span>
            <p class="mt-2 mb-1">
              <strong>Deadline:</strong> {{ task.deadline.strftime('%Y-%m-%d')
              if task.deadline else 'N/A' }}
            </p>

            <div class="mt-2 d-flex flex-wrap gap-1 align-items-center">
              {% for user in task.contributors %}
              <img
                src="{{ url_for('static', filename=user.profile_picture) }}"
                title="{{ user.fullname }}"
                class="rounded-circle"
                style="width: 30px; height: 30px; object-fit: cover"
                alt="{{ user.username }}"
              />
              {% endfor %} {% if current_user.id == project.created_by or
              current_user in project.contributors %}
              <button
                class="btn p-0 border rounded-circle d-inline-flex justify-content-center align-items-center ms-2"
                style="width: 32px; height: 32px"
                title="Set contributors"
                onclick="openSetTaskContributors({{ task.id }})"
              >
                <img
                  src="{{ url_for('static', filename='images/edit-icon.png') }}"
                  alt="Set contributors"
                  style="
                    width: 18px;
                    height: 18px;
                    object-fit: contain;
                    display: block;
                  "
                />
              </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- IN PROGRESS Column -->
      <div
        class="task-column flex-fill"
        ondrop="drop(event, 'In Progress')"
        ondragover="allowDrop(event)"
      >
        <h6 class="text-center fw-bold">IN PROGRESS</h6>
        {% for task in project.tasks if task.status == 'In Progress' %}
        <div
          class="card mb-3 position-relative"
          draggable="true"
          ondragstart="drag(event)"
          id="task-{{ task.id }}"
        >
          {% if current_user.id == project.created_by or current_user in
          project.contributors %}
          <button
            class="btn p-0 border rounded-circle d-inline-flex justify-content-center align-items-center"
            style="
              width: 28px;
              height: 28px;
              position: absolute;
              top: 6px;
              right: 6px;
              z-index: 10;
            "
            title="Delete task"
            onclick="deleteTask({{ task.id }})"
          >
            <img
              src="{{ url_for('static', filename='images/delete-icon.png') }}"
              alt="Delete task"
              style="
                width: 14px;
                height: 14px;
                object-fit: contain;
                display: block;
              "
            />
          </button>
          {% endif %}
          <div class="card-body">
            <h6 class="card-title">{{ task.name }}</h6>
            <p class="card-text">{{ task.description }}</p>
            <span
              class="badge bg-{{ 'danger' if task.priority == 3 else 'warning' if task.priority == 2 else 'success' }}"
            >
              Priority {{ task.priority }}
            </span>
            <p class="mt-2 mb-1">
              <strong>Deadline:</strong> {{ task.deadline.strftime('%Y-%m-%d')
              if task.deadline else 'N/A' }}
            </p>

            <div class="mt-2 d-flex flex-wrap gap-1 align-items-center">
              {% for user in task.contributors %}
              <img
                src="{{ url_for('static', filename=user.profile_picture) }}"
                title="{{ user.fullname }}"
                class="rounded-circle"
                style="width: 30px; height: 30px; object-fit: cover"
                alt="{{ user.username }}"
              />
              {% endfor %} {% if current_user.id == project.created_by or
              current_user in project.contributors %}
              <button
                class="btn p-0 border rounded-circle d-inline-flex justify-content-center align-items-center ms-2"
                style="width: 32px; height: 32px"
                title="Set contributors"
                onclick="openSetTaskContributors({{ task.id }})"
              >
                <img
                  src="{{ url_for('static', filename='images/edit-icon.png') }}"
                  alt="Set contributors"
                  style="
                    width: 18px;
                    height: 18px;
                    object-fit: contain;
                    display: block;
                  "
                />
              </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- DONE Column -->
      <div
        class="task-column flex-fill"
        ondrop="drop(event, 'Done')"
        ondragover="allowDrop(event)"
      >
        <h6 class="text-center fw-bold">DONE</h6>
        {% for task in project.tasks if task.status == 'Done' %}
        <div
          class="card mb-3 position-relative"
          draggable="true"
          ondragstart="drag(event)"
          id="task-{{ task.id }}"
        >
          {% if current_user.id == project.created_by or current_user in
          project.contributors %}
          <button
            class="btn p-0 border rounded-circle d-inline-flex justify-content-center align-items-center"
            style="
              width: 28px;
              height: 28px;
              position: absolute;
              top: 6px;
              right: 6px;
              z-index: 10;
            "
            title="Delete task"
            onclick="deleteTask({{ task.id }})"
          >
            <img
              src="{{ url_for('static', filename='images/delete-icon.png') }}"
              alt="Delete task"
              style="
                width: 14px;
                height: 14px;
                object-fit: contain;
                display: block;
              "
            />
          </button>
          {% endif %}

          <div class="card-body">
            <h6 class="card-title">{{ task.name }}</h6>
            <p class="card-text">{{ task.description }}</p>
            <span
              class="badge bg-{{ 'danger' if task.priority == 3 else 'warning' if task.priority == 2 else 'success' }}"
            >
              Priority {{ task.priority }}
            </span>
            <p class="mt-2 mb-1">
              <strong>Deadline:</strong> {{ task.deadline.strftime('%Y-%m-%d')
              if task.deadline else 'N/A' }}
            </p>

            <div class="mt-2 d-flex flex-wrap gap-1 align-items-center">
              {% for user in task.contributors %}
              <img
                src="{{ url_for('static', filename=user.profile_picture) }}"
                title="{{ user.fullname }}"
                class="rounded-circle"
                style="width: 30px; height: 30px; object-fit: cover"
                alt="{{ user.username }}"
              />
              {% endfor %} {% if current_user.id == project.created_by or
              current_user in project.contributors %}
              <button
                class="btn p-0 border rounded-circle d-inline-flex justify-content-center align-items-center ms-2"
                style="width: 32px; height: 32px"
                title="Set contributors"
                onclick="openSetTaskContributors({{ task.id }})"
              >
                <img
                  src="{{ url_for('static', filename='images/edit-icon.png') }}"
                  alt="Set contributors"
                  style="
                    width: 18px;
                    height: 18px;
                    object-fit: contain;
                    display: block;
                  "
                />
              </button>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% else %}
    <p class="text-muted">There are no tasks assigned to this project yet.</p>
    {% endif %}
  </div>
</div>

{# Template ascuns folosit de JS pentru "Add Task" (conținut Jinja randat în
HTML) #}
<template id="tpl-task-contributors">
  {% for user in project.contributors %}
  <div class="form-check d-flex align-items-center mb-2">
    <input
      class="form-check-input me-2"
      type="checkbox"
      value="{{ user.id }}"
      id="user-{{ user.id }}"
    />
    <img
      src="{{ url_for('static', filename=user.profile_picture) }}"
      alt="Pic"
      class="rounded-circle me-2"
      style="width: 30px; height: 30px; object-fit: cover"
    />
    <label class="form-check-label" for="user-{{ user.id }}">
      {{ user.fullname }} ({{ user.username }})
    </label>
  </div>
  {% endfor %} {% if current_user.id == project.created_by %}
  <div class="form-check d-flex align-items-center mb-2">
    <input
      class="form-check-input me-2"
      type="checkbox"
      value="{{ current_user.id }}"
      id="user-{{ current_user.id }}"
    />
    <img
      src="{{ url_for('static', filename=current_user.profile_picture) }}"
      alt="Pic"
      class="rounded-circle me-2"
      style="width: 30px; height: 30px; object-fit: cover"
    />
    <label class="form-check-label" for="user-{{ current_user.id }}">
      {{ current_user.fullname }} ({{ current_user.username }})
    </label>
  </div>
  {% endif %}
</template>

{% endblock %} {% block scripts_extra %} {% block scripts %}
<script defer src="{{ url_for('static', filename='js/project.js') }}"></script>
{% endblock %} {% endblock %}
