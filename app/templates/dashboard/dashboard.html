{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- <h1>Welcome to your Dashboard</h1>
<p>This is your task manager dashboard.</p> -->

<!-- Projects Section -->
<section class="section-title bg-light py-4 position-relative">
    <div class="section-header position-absolute top-0 start-50 translate-middle bg-light px-3">
        <h2 class="mb-0 text-primary">Your Projects</h2>
    </div>
    <div class="container-fluid">

        <div class="text-end mb-3">
            <button class="btn btn-primary fixed-btn" onclick="createProject()">Add a new project</button>
        </div>

        <div class="row flex-row flex-nowrap overflow-auto">
            {% if projects %}
                {% for project in projects %}
                <!-- Project Card -->
                    <div class="col-lg-3 col-md-4 col-sm-6 col-10 mb-3">
                    <div class="card h-100">
                        <div class="overflow-hidden" style="max-height: 200px;">
                        <img src="{{ url_for('static', filename=project.background_picture) }}"
                            class="img-fluid w-100" alt="Project Image" style="object-fit: cover;">
                        </div>
                        <div class="card-body d-flex flex-column">
                        <h5 class="card-title">{{ project.name }}</h5>
                        <p class="card-text">{{ project.description }}</p>

                        {% set status_colors = {
                            'Not Started': 'secondary',
                            'In Progress': 'primary',
                            'On Hold': 'warning',
                            'Needs Review': 'info',
                            'Completed': 'success',
                            'Cancelled': 'danger',
                            'Delayed': 'danger'
                        } %}

                        <div class="progress mb-2">
                            <div class="progress-bar bg-{{ status_colors.get(project.status, 'dark') }}"
                                role="progressbar"
                                style="width: {{ project.progress }}%"
                                aria-valuenow="{{ project.progress }}" aria-valuemin="0" aria-valuemax="100">
                            {{ project.progress }}%
                            </div>
                        </div>
                        <span class="badge bg-{{ status_colors.get(project.status, 'dark') }}">{{ project.status }}</span>

                        <p class="card-text mt-2">
                            <small class="text-muted">Last updated {{ project.updated_at }}</small>
                        </p>

                        <div class="mt-auto">
                            <a href="{{ url_for('projects.project_detail', project_id=project.id) }}"
                            class="btn btn-primary w-100">Go to Project</a>
                        </div>
                        </div>
                    </div>
                    </div>

                {% endfor %}
            {% else %}
                <div class="col-12 text-center">
                    <h5 class="text-muted">You have no projects yet. <a href="#" onclick="createProject()">Create a new project</a>.</h5>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<!-- Active Tasks Section -->
<section class="section-title bg-light py-4 position-relative">
    <div class="section-header position-absolute top-0 start-50 translate-middle bg-light px-3">
        <h2 class="mb-0">Active Tasks</h2>
    </div>
    <div class="container-fluid">
        <div class="row">
        {% if tasks %}
            {% for task in tasks %}
            {% set bar_color = 'danger' if task.days_left == 0 else 'info' %}
            {% set status_color =
                'secondary' if task.status == 'To Do' else
                'primary' if task.status == 'In Progress' else
                'success' if task.status == 'Done' else
                'dark'
            %}
            <div class="col-lg-3 col-md-6 mb-3">
                <div class="card h-100">
                    <div class="card-body">
                        <h5 class="card-title">{{ task.name }}</h5>
                        <p class="card-text">{{ task.description }}</p>

                        <div class="position-relative mb-2" style="height: 20px;">
                            <div class="progress" style="height: 100%;">
                                <div class="progress-bar bg-{{ bar_color }}"
                                    role="progressbar"
                                    style="width: {{ task.progress }}%;"
                                    aria-valuenow="{{ task.progress }}"
                                    aria-valuemin="0" aria-valuemax="100">
                                </div>
                            </div>
                            <div class="position-absolute w-100 text-center" style="top: 0; font-size: 0.85rem;">
                                {% if task.days_left is not none %}
                                    {{ task.days_left }} day{{ 's' if task.days_left != 1 else '' }} left
                                {% else %}
                                    No deadline
                                {% endif %}
                            </div>
                        </div>


                        <p class="card-text">
                            <small class="text-muted">
                                Deadline: {{ task.deadline.strftime('%Y-%m-%d') if task.deadline else 'N/A' }}
                            </small>
                        </p>

                        <p class="mb-2">
                            <span class="badge bg-{{ status_color }}">{{ task.status }}</span>
                        </p>

                        <p>
                            <span class="badge bg-{{ 'danger' if task.priority == 3 else 'warning' if task.priority == 2 else 'success' }}">
                                Priority {{ task.priority }}
                            </span>
                        </p>

                        <a href="{{ url_for('projects.project_detail', project_id=task.project.id) }}" class="btn btn-primary">Go to Project</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="col-12 text-center">
                <p class="text-muted">You have no active tasks assigned.</p>
            </div>
        {% endif %}
        </div>
    </div>
</section>


<!-- Style -->
<style>
    .section-title {
        border-top: 2px solid #007bff;
    }

    .section-header {
        top: -15px;
        transform: translateX(-50%);
        z-index: 10;
    }

    .section-header h2 {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
    }
</style>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    /* Toggle Switch Style */
    .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 26px;
        margin-top: 10px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: #4caf50;
    }

    input:checked + .slider:before {
        transform: translateX(24px);
    }

    /* Optional label styling */
    .toggle-label {
        font-size: 14px;
        margin-left: 8px;
        vertical-align: middle;
    }
</style>

<script>
    function createProject() {
        Swal.fire({
            title: 'Create a New Project',
            html: `
                <form id="project-form" enctype="multipart/form-data">
                    <input type="text" id="project-name" class="swal2-input" placeholder="Project Name" required>
                    <textarea id="project-description" class="swal2-textarea" placeholder="Project Description" required></textarea>
                    <input type="file" id="background-picture" class="swal2-file" accept="image/*">
                    
                    <div style="margin-top: 15px;">
                        <label class="switch">
                            <input type="checkbox" id="project-public" checked>
                            <span class="slider"></span>
                        </label>
                        <span class="toggle-label">Public</span>
                    </div>
                </form>
            `,
            focusConfirm: false,
            preConfirm: () => {
                const name = document.getElementById('project-name').value;
                const description = document.getElementById('project-description').value;
                const file = document.getElementById('background-picture').files[0];
                const isPublic = document.getElementById('project-public').checked;

                if (!name || !description) {
                    Swal.showValidationMessage('Please fill out the name and description.');
                    return false;
                }

                const formData = new FormData();
                formData.append('name', name);
                formData.append('description', description);
                formData.append('is_public', isPublic ? 'true' : 'false');
                if (file) {
                    formData.append('background_picture', file);
                }

                return formData;
            },
            confirmButtonText: 'Create',
            showCancelButton: true,
        }).then((result) => {
            if (result.isConfirmed) {
                fetch('/create-project', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
                    },
                    body: result.value
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Success', 'Project created successfully!', 'success')
                            .then(() => location.reload());
                    } else {
                        Swal.fire('Error', data.message || 'Failed to create project. Please try again.', 'error');
                    }
                })
                .catch(() => {
                    Swal.fire('Error', 'An unexpected error occurred.', 'error');
                });
            }
        });
    }
</script>


{% endblock %}
